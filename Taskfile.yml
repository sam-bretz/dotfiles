# Taskfile.yml - Consolidated dotfiles task runner
# https://taskfile.dev
version: '3'

vars:
  DOTFILES_ROOT: '{{.PWD}}'
  BACKUP_DIR: '{{.DOTFILES_ROOT}}/backup'
  TIMESTAMP: '{{now | date "20060102_150405"}}'

env:
  DOTFILES_PATH: '{{.DOTFILES_ROOT}}'
  HOMEBREW_BUNDLE_FILE: '{{.DOTFILES_ROOT}}/brew/Brewfile'

tasks:
  # ============================================================================
  # PRIMARY COMMANDS
  # ============================================================================
  
  default:
    desc: "Show available tasks"
    cmds:
      - task --list

  help:
    desc: "Show usage guide"
    cmds:
      - echo 'Dotfiles Task Runner - Consolidated'
      - echo ''
      - echo 'Primary Commands:'
      - echo '  install     - Complete system setup'
      - echo '  maintain    - Universal maintenance (recommended)'
      - echo '  update      - Update all packages and plugins'
      - echo '  doctor      - System health check'
      - echo '  backup      - Create backup'
      - echo '  config      - Edit configurations'
      - echo ''
      - echo 'Shortcuts - m=maintain, u=update, d=doctor, b=backup'

  # ============================================================================
  # UNIVERSAL MAINTENANCE - THE ONE COMMAND TO RULE THEM ALL
  # ============================================================================

  maintain:
    desc: "Universal maintenance - does everything needed to keep system healthy"
    cmds:
      - echo "ðŸ”§ Starting Universal Maintenance..."
      - echo ""
      - task: backup
      - echo ""
      - task: update
      - echo ""
      - task: clean
      - echo ""
      - task: doctor
      - echo ""
      - task: sync
      - echo ""
      - echo "âœ¨ Universal maintenance complete!"
      - echo "Your system is now fully updated, cleaned, and healthy! ðŸŽ‰"

  # ============================================================================
  # CORE OPERATIONS
  # ============================================================================

  install:
    desc: "Complete dotfiles installation and setup"
    cmds:
      - echo "ðŸš€ Starting complete installation..."
      - task: backup
      - echo "ðŸ“¦ Installing Homebrew packages..."
      - 'cd {{.DOTFILES_ROOT}}/brew && brew bundle install --file=Brewfile'
      - echo "ðŸ› ï¸ Setting up modern CLI tools..."
      - '{{.DOTFILES_ROOT}}/setup-modern-cli.sh'
      - echo "ðŸ”— Creating symlinks..."
      - 'cd {{.DOTFILES_ROOT}} && stow -v alacritty aerospace nvim tmux zsh git bin 2>/dev/null || true'
      - task: doctor
      - echo "âœ… Installation complete!"

  update:
    desc: "Update all packages, plugins, and dependencies"
    cmds:
      - echo "ðŸ”„ Updating everything..."
      - echo "  â€¢ Homebrew packages..."
      - brew update
      - brew upgrade
      - brew cleanup
      - echo "  â€¢ Neovim plugins..."
      - nvim --headless "+Lazy! sync" +qa 2>/dev/null || true
      - echo "  â€¢ Tmux plugins..."
      - 'test -d ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/update_plugins all || echo "    TPM not found"'
      - echo "  â€¢ Brewfile sync..."
      - '{{.DOTFILES_ROOT}}/bin/update-brewfile || true'
      - echo "âœ… All updates complete!"

  doctor:
    desc: "Comprehensive system health check"
    cmds:
      - echo "ðŸ¥ System Health Check"
      - echo ""
      - |
        echo "Homebrew:"
        if command -v brew >/dev/null 2>&1; then
          echo "  âœ“ Installed ($(brew --version | head -1))"
          outdated=$(brew outdated --formula | wc -l | tr -d ' ')
          if [ "$outdated" -gt 0 ]; then
            echo "  âš  $outdated packages outdated (run 'task update' to fix)"
          else
            echo "  âœ“ All packages up to date"
          fi
        else
          echo "  âœ— Homebrew not installed"
        fi
      - |
        echo "Git:"
        if command -v git >/dev/null 2>&1; then
          echo "  âœ“ Installed ($(git --version | cut -d' ' -f3))"
          if git config --get user.email >/dev/null; then
            echo "  âœ“ User configured ($(git config --get user.email))"
          else
            echo "  âš  User not configured"
          fi
        else
          echo "  âœ— Git not installed"
        fi
      - |
        echo "Shell:"
        echo "  âœ“ Current: $SHELL"
        if [ -d ~/.oh-my-zsh ]; then
          echo "  âœ“ Oh My Zsh installed"
        else
          echo "  âš  Oh My Zsh not installed"
        fi
      - |
        echo "Editors:"
        if command -v nvim >/dev/null 2>&1; then
          echo "  âœ“ Neovim ($(nvim --version | head -1 | cut -d' ' -f2))"
        else
          echo "  âœ— Neovim not installed"
        fi
        if command -v tmux >/dev/null 2>&1; then
          echo "  âœ“ Tmux ($(tmux -V | cut -d' ' -f2))"
        else
          echo "  âœ— Tmux not installed"
        fi
      - |
        echo "Modern CLI:"
        tools=(eza bat zoxide delta lazygit yazi)
        for tool in "${tools[@]}"; do
          if command -v "$tool" >/dev/null 2>&1; then
            echo "  âœ“ $tool"
          else
            echo "  âš  $tool missing"
          fi
        done
      - echo ""
      - echo "âœ… Health check complete!"

  backup:
    desc: "Create timestamped backup of dotfiles"
    vars:
      BACKUP_PATH: '{{.BACKUP_DIR}}/dotfiles_{{.TIMESTAMP}}.tar.gz'
    cmds:
      - echo "Creating backup..."
      - mkdir -p {{.BACKUP_DIR}}
      - tar -czf {{.BACKUP_PATH}} --exclude=.git --exclude=backup -C {{.DOTFILES_ROOT}} .
      - echo "Backup created at {{.BACKUP_PATH}}"

  clean:
    desc: "Clean system caches and temporary files"
    cmds:
      - echo "ðŸ§¹ Cleaning system..."
      - echo "  â€¢ Homebrew caches..."
      - brew cleanup -s 2>/dev/null || true
      - brew autoremove 2>/dev/null || true
      - echo "  â€¢ Neovim caches..."
      - rm -rf ~/.local/share/nvim/swap ~/.local/share/nvim/shada ~/.local/share/nvim/undo 2>/dev/null || true
      - echo "  â€¢ System temporary files..."
      - rm -rf /tmp/nvim* 2>/dev/null || true
      - echo "âœ… Cleanup complete!"

  sync:
    desc: "Sync configurations and git repository"
    dir: '{{.DOTFILES_ROOT}}'
    cmds:
      - echo "ðŸ”„ Syncing configurations..."
      - echo "  â€¢ Reloading tmux..."
      - tmux source-file ~/.tmux.conf 2>/dev/null || echo "    Tmux not running"
      - echo "  â€¢ Checking git status..."
      - git status -s
      - |
        if [ -n "$(git status --porcelain)" ]; then
          echo "  âš  Uncommitted changes found"
          echo "    Use 'git add -A && git commit -m \"message\"' to commit"
        else
          echo "  âœ“ Git repository clean"
        fi
      - echo "âœ… Sync complete!"

  config:
    desc: "Quick access to edit key configurations"
    cmds:
      - echo "âš™ï¸ Configuration Quick Access:"
      - echo "  zshrc      - nvim ~/.dotfiles/zsh/.zshrc"
      - echo "  nvim       - nvim ~/.dotfiles/nvim/.config/nvim/"
      - echo "  tmux       - nvim ~/.dotfiles/tmux/.tmux.conf"
      - echo "  alacritty  - nvim ~/.dotfiles/alacritty/.config/alacritty/alacritty.toml"
      - echo "  aerospace  - nvim ~/.dotfiles/aerospace/aerospace.toml"
      - echo "  taskfile   - nvim ~/.dotfiles/Taskfile.yml"

  # ============================================================================
  # SPECIALIZED OPERATIONS
  # ============================================================================

  git:
    desc: "Git operations for dotfiles"
    dir: '{{.DOTFILES_ROOT}}'
    cmds:
      - echo "ðŸ“Š Dotfiles Git Status"
      - git status -sb
      - echo ""
      - echo "Recent commits:"
      - git log --oneline -5
      - echo ""
      - echo "Use 'git add -A && git commit -m \"message\"' to commit changes"

  brew:
    desc: "Homebrew operations"
    cmds:
      - echo "ðŸº Homebrew Operations"
      - |
        echo "Installed packages: $(brew list --formula | wc -l | tr -d ' ') formulae, $(brew list --cask | wc -l | tr -d ' ') casks"
        outdated=$(brew outdated --formula | wc -l | tr -d ' ')
        if [ "$outdated" -gt 0 ]; then
          echo "Outdated packages: $outdated"
          echo "Run 'task update' to upgrade all packages"
        else
          echo "All packages up to date âœ“"
        fi

  nvim:
    desc: "Neovim operations"
    cmds:
      - echo "ðŸŽ¨ Neovim Operations"
      - echo "Syncing plugins..."
      - nvim --headless "+Lazy! sync" +qa
      - echo "Running health check..."
      - nvim "+checkhealth" "+qa" || true

  emergency:
    desc: "Emergency reset and reinstall (use with caution)"
    cmds:
      - echo "ðŸš¨ Emergency Reset - This will reset all configurations!"
      - echo "Creating emergency backup first..."
      - task: backup
      - echo "Removing symlinks..."
      - 'cd {{.DOTFILES_ROOT}} && stow -D alacritty aerospace nvim tmux zsh git bin 2>/dev/null || true'
      - echo "Reinstalling..."
      - task: install
      - echo "ðŸ†˜ Emergency reset complete!"

  # ============================================================================
  # QUICK SHORTCUTS
  # ============================================================================

  m:
    desc: "Quick maintain (universal maintenance)"
    cmds: [task: maintain]

  u:
    desc: "Quick update"
    cmds: [task: update]

  d:
    desc: "Quick doctor"
    cmds: [task: doctor]

  b:
    desc: "Quick backup"
    cmds: [task: backup]

  s:
    desc: "Quick sync"
    cmds: [task: sync]

  g:
    desc: "Quick git status"
    cmds: [task: git]